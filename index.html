<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul class="comments" id="list">
        <!-- список рендерится из js -->
      </ul>
      <div class="add-form">
        <input
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
          id="name-input"
        />
        <textarea
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш комментарий"
          rows="4"
          id="text-input"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button" id="send-button">Написать</button>
        </div>
      </div>
    </div>

    <script>
      const nameInputElement = document.getElementById("name-input");
      const textInputElement = document.getElementById("text-input");
      const buttonElement = document.getElementById("send-button");
      const listElement = document.getElementById("list");

      // Функция для получения комментариев
      const getComments = () => {
        fetch('https://wedev-api.sky.pro/api/v1/:elizaveta-aleksandrova/comments', {
          method: "GET",
        })
        .then((response) =>{
          if (!response.ok) {
            throw new Error('Ошибка при получении комментариев');
          }
          return response.json();
        })
        .then((responseData) => {
          const appComments = responseData.comments.map((comment) => {
            return {
              name: comment.author.name,
              date: new Date(comment.date),
              text: comment.text,
              likes: comment.likes,
              isLiked: comment.isLiked,
            };
          });

          comments = appComments;
          renderComments();
        })
        .catch((error) => {
          console.error('Ошибка:', error);
        });
      };

      // Функция для рендеринга комментариев
      const renderComments = () => {
        const commentsHtml = comments.map((comment, index) => {
          // Добавляем класс active-like, если isLiked равно true
          const likeButtonClass = comment.isLiked ? 'like-button active-like' : 'like-button';
          return `<li class="comment">
            <div class="comment-header">
              <div>${comment.name}</div>
              <div>${comment.date}</div>
            </div>
            <div class="comment-body">
              <div class="comment-text">
                ${comment.text}
              </div>
            </div>
            <div class="comment-footer">
              <div class="likes">
                <span class="likes-counter">${comment.likes}</span>
                <button data-index="${index}" class="${likeButtonClass}"></button>
              </div>
            </div>
          </li>`;
        }).join("");

        listElement.innerHTML = commentsHtml;
        initLikeButtonListeners();
      };

      // Инициализация обработчика событий на клик по кнопке лайка
      const initLikeButtonListeners = () => {
        const likeButtonElements = document.querySelectorAll(".like-button");

        for (const likeButtonElement of likeButtonElements) {
          likeButtonElement.addEventListener('click', () => {
            const index = likeButtonElement.dataset.index;

            // Изменяем значение isLiked и число лайков в соответствии с текущим состоянием кнопки 
            comments[index].isLiked = !comments[index].isLiked;
            if (comments[index].isLiked) {
              comments[index].likes++;
            } else {
              comments[index].likes--;
            }

            // Обновляем отображение кнопки "лайк"
            renderComments();
          });
        }
      };

      // Обработчик событий на кнопку отправить
      buttonElement.addEventListener('click', () =>{
        let currentDate = new Date();
        let formattedDateTime = ('0' + currentDate.getDate()).slice(-2) + '.' + ('0' + (currentDate.getMonth() + 1)).slice(-2) + '.' + ('' + currentDate.getFullYear()).slice(-2) + ' ' + ('0' + currentDate.getHours()).slice(-2) + ':' + ('0' + currentDate.getMinutes()).slice(-2);
        nameInputElement.classList.remove('error');
        textInputElement.classList.remove('error');

        // Валидация инпута на пустые строки
        if(nameInputElement.value.trim() === '' && textInputElement.value.trim() === ''){
          nameInputElement.classList.add('error');
          textInputElement.classList.add('error');
          return;
        }
        else if(textInputElement.value.trim() === ''){
          textInputElement.classList.add('error');
          return;
        }
        else if(nameInputElement.value.trim() === ''){
          nameInputElement.classList.add('error');
          return;
        };

        // Выполнение POST запроса для добавления нового комментария
        const fetchPromise = fetch(
          'https://wedev-api.sky.pro/api/v1/:elizaveta-aleksandrova/comments',
          {
            method:"POST",
            body:JSON.stringify({
              name:nameInputElement.value,
              text:textInputElement.value,
            }),
          });

        fetchPromise.then((response) =>{
          if (!response.ok) {
            throw new Error('Ошибка при отправке комментария');
          }
          return response.json();
        }).then((responseData) => {
          // После успешного выполнения POST запроса вызываем функцию для получения комментариев
          getComments();
        }).catch((error) => {
          console.error('Ошибка:', error);
          // Отображаем сообщение об ошибке на странице
          errorElement.textContent = 'Ошибка при отправке комментария';
        });
        // Очистка инпутов
        textInputElement.value = '';
        nameInputElement.value = '';
      });
      // Вызов функции получения комментариев при загрузке страницы
      getComments();
    </script>
  </body>
</html>
